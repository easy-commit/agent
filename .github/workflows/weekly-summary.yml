name: Weekly Recap to Discord

on:
  schedule:
    - cron: '0 18 * * 0' # Every Sunday at 18:00 UTC

jobs:
  weekly-recap:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Generate weekly summary and post to Discord
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          START_DATE=$(date -u -d "7 days ago" +"%Y-%m-%dT00:00:00Z")
          END_DATE=$(date -u +"%Y-%m-%dT23:59:59Z")
          REPO="${{ github.repository }}"

          commits=$(gh api repos/$REPO/commits \
            --paginate -q "[.[] | select(.commit.author.date >= \"$START_DATE\")] | length")

          prs_open=$(gh api repos/$REPO/pulls \
            --paginate -q "[.[] | select(.created_at >= \"$START_DATE\")] | length")

          prs_merged=$(gh api repos/$REPO/pulls \
            --state=closed --paginate -q "[.[] | select(.merged_at != null and .merged_at >= \"$START_DATE\")] | length")

          contributors=$(gh api repos/$REPO/commits \
            --paginate -q "[.[] | select(.commit.author.date >= \"$START_DATE\")] | .[].author.login" | sort -u | wc -l)

          message="<@&123456789012345678> ðŸ“Š Here's the weekly recap for \`$REPO\`:"

          jq -n --arg message "$message" \
                --argjson commits "$commits" \
                --argjson prs_open "$prs_open" \
                --argjson prs_merged "$prs_merged" \
                --argjson contributors "$contributors" \
                --arg date "$(date -u +"%B %d, %Y")" \
                '
                {
                  username: "EasyCommit Bot",
                  content: $message,
                  embeds: [{
                    title: "ðŸ—“ï¸ Weekly Summary (" + $date + ")",
                    description: "**ðŸ“¦ Commits:** \($commits)\n**ðŸ”€ Pull Requests:** \($prs_open) opened, \($prs_merged) merged\n**ðŸ‘¥ Active Contributors:** \($contributors)",
                    color: 5814783,
                    footer: { text: "GitHub Stats for the Week" },
                    timestamp: now
                  }]
                }' > summary.json

          curl -X POST -H "Content-Type: application/json" \
               -d @summary.json "$DISCORD_WEBHOOK"
